<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>handlers/permissions.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Mirasaki/discord.js-bot-template" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Modules</h3><ul><li><a href="module-Client.html">Client</a></li><li><a href="module-Handler_Commands.html">Handler/Commands</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~checkCommandCanExecute">checkCommandCanExecute</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~clearApplicationCommandData">clearApplicationCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandInfoEmbed">generateCommandInfoEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandOverviewEmbed">generateCommandOverviewEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandMap">getCommandMap</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandSelectMenu">getCommandSelectMenu</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getThrottleId">getThrottleId</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~hasAccessToComponentCommand">hasAccessToComponentCommand</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~isAppropriateCommandFilter">isAppropriateCommandFilter</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~logCommandApiData">logCommandApiData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~refreshSlashCommandData">refreshSlashCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerGlobalCommands">registerGlobalCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerTestServerCommands">registerTestServerCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~sortCommandsByCategory">sortCommandsByCategory</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~throttleCommand">throttleCommand</a></li></ul></li><li><a href="module-Handler_Permissions.html">Handler/Permissions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getInvalidPerms">getInvalidPerms</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getPermissionLevel">getPermissionLevel</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~hasChannelPerms">hasChannelPerms</a></li></ul></li><li><a href="module-Utils.html">Utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Utils.html#~capitalizeString">capitalizeString</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~colorResolver">colorResolver</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getBotInviteLink">getBotInviteLink</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getFiles">getFiles</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRelativeTime">getRelativeTime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRuntime">getRuntime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~parseSnakeCaseArray">parseSnakeCaseArray</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~sleep">sleep</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~splitCamelCaseStr">splitCamelCaseStr</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~titleCase">titleCase</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="APICommand.html">APICommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="APICommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ChatInputCommand.html">ChatInputCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="CommandBase.html">CommandBase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CommandBase.html#load">load</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ComponentCommand.html">ComponentCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ComponentCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="MessageContextCommand.html">MessageContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="UserContextCommand.html">UserContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UserContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#validateConfig">validateConfig</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-commands.html">adding-commands</a></li><li><a href="tutorial-permissions.html">permissions</a></li></ul><h3>Externals</h3><ul><li><a href="external-DiscordActionRowBuilder.html">DiscordActionRowBuilder</a></li><li><a href="external-DiscordActivityOptions.html">DiscordActivityOptions</a></li><li><a href="external-DiscordAPIApplicationCommand.html">DiscordAPIApplicationCommand</a></li><li><a href="external-DiscordChatInputInteraction.html">DiscordChatInputInteraction</a></li><li><a href="external-DiscordClient.html">DiscordClient</a></li><li><a href="external-DiscordClientPresenceStatus.html">DiscordClientPresenceStatus</a></li><li><a href="external-DiscordCollection.html">DiscordCollection</a></li><li><a href="external-DiscordCommandInteraction.html">DiscordCommandInteraction</a></li><li><a href="external-DiscordEmbedBuilder.html">DiscordEmbedBuilder</a></li><li><a href="external-DiscordGatewayIntentBits.html">DiscordGatewayIntentBits</a></li><li><a href="external-DiscordGuildChannel.html">DiscordGuildChannel</a></li><li><a href="external-DiscordGuildMember.html">DiscordGuildMember</a></li><li><a href="external-DiscordPermissionResolvable.html">DiscordPermissionResolvable</a></li></ul><h3>Global</h3><ul><li><a href="global.html#APICommandConfig">APICommandConfig</a></li><li><a href="global.html#BaseConfig">BaseConfig</a></li><li><a href="global.html#CommandBaseCooldown">CommandBaseCooldown</a></li><li><a href="global.html#CommandCallback">CommandCallback</a></li><li><a href="global.html#CooldownTypes">CooldownTypes</a></li><li><a href="global.html#PermLevel">PermLevel</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">handlers/permissions.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Our permission handler, holds utility functions and everything to do with
 * handling permissions in this template. Exported from `/src/handlers/permissions.js`.
 * See {@tutorial permissions} for an overview.
 * @module Handler/Permissions
 */

const { PermissionsBitField } = require('discord.js');
const config = require('../../config');

/**
 * The `discord.js` GuildMember object
 * @external DiscordGuildMember
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/GuildMember}
 */

/**
 * The `discord.js` GuildChannel object
 * @external DiscordGuildChannel
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/GuildChannel}
 */

/**
 * Check if the command invoker has this level
 * @typedef {Function} hasLevel
 * @param {external:DiscordGuildMember} member The Discord API member object
 * @param {external:DiscordGuildChannel} [channel] The Discord API channel object
 * @returns {boolean} Indicates if the invoke has this permission level
 */

/**
 * Represents a valid permission configuration data entry
 * @typedef {Object} PermConfigEntry
 * @property {string} name The name of the permission level
 * @property {number} level The level of the permission level
 * @property {module:Handler/Permissions~hasLevel} hasLevel Indicates if the invoker has this permission level
 */

/**
 * Our ordered permission level configuration
 * @member {Array&lt;module:Handler/Permissions~PermConfigEntry>} permConfig
 */
const permConfig = [
  {
    name: 'User',
    level: 0,
    hasLevel: () => true
  },

  {
    name: 'Moderator',
    level: 1,
    hasLevel: (member, channel) => hasChannelPerms(
      member.id, channel, ['KickMembers', 'BanMembers']
    ) === true
  },

  {
    name: 'Administrator',
    level: 2,
    hasLevel: (member, channel) => hasChannelPerms(member.id, channel, ['Administrator']) === true
  },

  {
    name: 'Server Owner',
    level: 3,
    hasLevel: (member, channel) => {
      // Shorthand
      // hasLevel: (member, channel) => (channel.guild?.ownerId === member.user?.id)
      // COULD result in (undefined === undefined)
      if (channel.guild &amp;&amp; channel.guild.ownerId) {
        return (channel.guild.ownerId === member.id);
      }
      return false;
    }
  },

  {
    name: 'Developer',
    level: 4,
    hasLevel: (member) => config.permissions.developers.includes(member.id)
  },

  {
    name: 'Bot Owner',
    level: 5,
    hasLevel: (member) => config.permissions.ownerId === member.id
  }
];

/**
 * Enum for our permission levels/names
 * @readonly
 * @enum {string}
 */
const permLevelMap = { ...permConfig.map(({ name }) => name) };

// [DEV] - document
const getPermLevelName = (integer) => permConfig.find((cfg) => cfg.level === integer)?.name;


/**
 * Our {@link Handler/Permissions~PermConfig} sorted by perm level, highest first
 * @member {Array&lt;module:Handler/Permissions~PermConfigEntry>} sortedPermConfig
 */
const sortedPermConfig = permConfig.sort((a, b) => {
  return b.level - a.level;
});

/**
 * Resolves someone's permission level
 * @method getPermissionLevel
 * @param {external:DiscordGuildMember} member The Discord API member object
 * @param {external:DiscordGuildChannel} channel The Discord API channel object
 * @returns {number} The member's permission level
 */
const getPermissionLevel = (member, channel) => {
  for (const currLvl of sortedPermConfig) {
    if (currLvl.hasLevel(member, channel)) {
      return currLvl.level;
    }
  }
};

/**
 * Check if an array of permission strings has any invalid API permissions
 * @param {Array&lt;string>} permArr Array of permission in string form
 * @returns {Array&lt;external:DiscordPermissionResolvable>} Array of invalid permissions
 */
const getInvalidPerms = (permArr) =>
  permArr.filter((perm) => typeof PermissionsBitField.Flags[perm] === 'undefined');

/**
 * Check if a user has specific permissions in a channel
 * @param {string} userId The ID of the user
 * @param {DiscordGuildChannel} channel The channel to check permissions in
 * @param {Array&lt;string>} permArr The array of permissions to check for
 * @returns {true | Array&lt;external:DiscordPermissionResolvable>} True if the member has all permissions,
 * or the array of missing permissions
 */
const hasChannelPerms = (userId, channel, permArr) => {
  // Convert string to array
  if (typeof permArr === 'string') permArr = [permArr];

  // Making sure all our perms are valid
  const invalidPerms = getInvalidPerms(permArr);
  if (invalidPerms.length >= 1) {
    throw new Error(`Invalid Discord permissions were provided: ${invalidPerms.join(', ')}`);
  }

  // Return the entire array if no permissions are found
  if (!channel.permissionsFor(userId)) return permArr;

  // Filter missing permissions
  const missingPerms = permArr.filter((perm) => !channel.permissionsFor(userId).has(PermissionsBitField.Flags[perm]));
  return missingPerms.length >= 1 ? missingPerms : true;
};

module.exports = {
  permConfig,
  sortedPermConfig,
  permLevelMap,
  getPermLevelName,
  getPermissionLevel,
  getInvalidPerms,
  hasChannelPerms
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Aug 22 2022 21:03:18 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
