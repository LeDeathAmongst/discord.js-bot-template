<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>classes/Commands.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Mirasaki/discord.js-bot-template" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Modules</h3><ul><li><a href="module-Client.html">Client</a></li><li><a href="module-Handler_Commands.html">Handler/Commands</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~checkCommandCanExecute">checkCommandCanExecute</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~clearApplicationCommandData">clearApplicationCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandInfoEmbed">generateCommandInfoEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandOverviewEmbed">generateCommandOverviewEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandMap">getCommandMap</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandSelectMenu">getCommandSelectMenu</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getThrottleId">getThrottleId</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~hasAccessToComponentCommand">hasAccessToComponentCommand</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~isAppropriateCommandFilter">isAppropriateCommandFilter</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~logCommandApiData">logCommandApiData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~refreshSlashCommandData">refreshSlashCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerGlobalCommands">registerGlobalCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerTestServerCommands">registerTestServerCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~sortCommandsByCategory">sortCommandsByCategory</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~throttleCommand">throttleCommand</a></li></ul></li><li><a href="module-Handler_Permissions.html">Handler/Permissions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getInvalidPerms">getInvalidPerms</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getPermissionLevel">getPermissionLevel</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~hasChannelPerms">hasChannelPerms</a></li></ul></li><li><a href="module-Utils.html">Utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Utils.html#~capitalizeString">capitalizeString</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~colorResolver">colorResolver</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getBotInviteLink">getBotInviteLink</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getFiles">getFiles</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRelativeTime">getRelativeTime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRuntime">getRuntime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~parseSnakeCaseArray">parseSnakeCaseArray</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~sleep">sleep</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~splitCamelCaseStr">splitCamelCaseStr</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~titleCase">titleCase</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="APICommand.html">APICommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="APICommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ChatInputCommand.html">ChatInputCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="CommandBase.html">CommandBase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CommandBase.html#load">load</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ComponentCommand.html">ComponentCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ComponentCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="MessageContextCommand.html">MessageContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="UserContextCommand.html">UserContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UserContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#validateConfig">validateConfig</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-commands.html">adding-commands</a></li><li><a href="tutorial-permissions.html">permissions</a></li></ul><h3>Externals</h3><ul><li><a href="external-DiscordActionRowBuilder.html">DiscordActionRowBuilder</a></li><li><a href="external-DiscordActivityOptions.html">DiscordActivityOptions</a></li><li><a href="external-DiscordAPIApplicationCommand.html">DiscordAPIApplicationCommand</a></li><li><a href="external-DiscordChatInputInteraction.html">DiscordChatInputInteraction</a></li><li><a href="external-DiscordClient.html">DiscordClient</a></li><li><a href="external-DiscordClientPresenceStatus.html">DiscordClientPresenceStatus</a></li><li><a href="external-DiscordCollection.html">DiscordCollection</a></li><li><a href="external-DiscordCommandInteraction.html">DiscordCommandInteraction</a></li><li><a href="external-DiscordEmbedBuilder.html">DiscordEmbedBuilder</a></li><li><a href="external-DiscordGatewayIntentBits.html">DiscordGatewayIntentBits</a></li><li><a href="external-DiscordGuildChannel.html">DiscordGuildChannel</a></li><li><a href="external-DiscordGuildMember.html">DiscordGuildMember</a></li><li><a href="external-DiscordPermissionResolvable.html">DiscordPermissionResolvable</a></li></ul><h3>Global</h3><ul><li><a href="global.html#APICommandConfig">APICommandConfig</a></li><li><a href="global.html#BaseConfig">BaseConfig</a></li><li><a href="global.html#CommandBaseCooldown">CommandBaseCooldown</a></li><li><a href="global.html#CommandCallback">CommandCallback</a></li><li><a href="global.html#CooldownTypes">CooldownTypes</a></li><li><a href="global.html#PermLevel">PermLevel</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">classes/Commands.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {
  permConfig,
  permLevelMap,
  getInvalidPerms
} = require('../handlers/permissions');
const {
  DEBUG_ENABLED
} = process.env;
const path = require('path');
const chalk = require('chalk');
const logger = require('@mirasaki/logger');

/**
 * The interaction object received when a user/member invokes the command
 * @external DiscordChatInputInteraction
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/ChatInputCommandInteraction}
 */

/**
 * The discord.js DiscordPermissionResolvable
 * @external DiscordPermissionResolvable
 * @see {@link https://discord.js.org/#/docs/discord.js/main/typedef/DiscordPermissionResolvable}
 */

/**
 * Valid permission levels
 * @typedef {'User' | 'Moderator' | 'Administrator' | 'Server Owner' | 'Developer' | 'Bot Owner'} PermLevel
 */

/**
 * Available cooldown types
 * @typedef {'user' | 'member' | 'guild' | 'channel' | 'global'} CooldownTypes
 */

/**
 * Command cooldown/throttling configuration
 * @typedef {Object} CommandBaseCooldown
 * @property {CooldownTypes} [type] The type of command throttling applied to this command
 * @property {number} [usages] The amount of times the command can be used within the specified duration
 * @property {number} [duration] The duration (in seconds) usages should be tracked for
 */

/**
 * The user-provided callback executed when the command is ran
 * @typedef {Function} CommandCallback
 * @param {external:DiscordChatInputInteraction} interaction The interaction received
 * @param {Client} client Our discord.js-extended client
 * @returns {void | Promise&lt;void>}
 */

/**
 * @typedef {Object} BaseConfig
 * @property {PermLevel} [permLevel='User'] The permission level required to use the command
 * @property {Array&lt;string>} [clientPerms=[]] Permissions required by the client to execute the command
 * @property {Array&lt;string>} [userPerms=[]] Permissions required by the user to execute the commands
 * @property {boolean} [enabled=true] Is the command currently enabled
 * @property {boolean} [nsfw=false] Is the command Not Safe For Work
 * @property {CommandBaseCooldown} [cooldown={ type: 'member', usages: 1, duration: 2 }] Cooldown configuration for the command
 * @property {string} [category='parent_folder_name'] This command's category
 * @property {string} [filePath='absolute_origin_path'] Path to file, automatically set, can be overwritten, only invoked on command reloads
 * @property {Object} [data={}] Discord API Application Command Object {@link https://discord.com/developers/docs/interactions/application-commands#application-command-object}
 * @property {CommandCallback} run The callback to execute when the command is invoked/called
 */

/** Represents the base class used for all our commands &amp; components */
class CommandBase {
  /**
   * @param {BaseConfig} config The full command configuration
   */
  constructor (config) {
    /**
     * @property {PermLevel} permLevel The permission level required to use the command
     */
    this.permLevel = config.permLevel || permConfig[permConfig.length - 1].name;

    /**
     * @property {Array&lt;external:DiscordPermissionResolvable>} clientPerms Permissions required by the client to execute the command
     */
    this.clientPerms = config.clientPerms || [];

    /**
     * @property {Array&lt;external:DiscordPermissionResolvable>} userPerms Permissions required by the user to execute the commands
     */
    this.userPerms = config.userPerms || [];

    /**
     * @property {boolean} enabled Is the command currently enabled
     */
    this.enabled = config.enabled || true;

    /**
     * @property {boolean} nsfw Is the command Not Safe For Work
     */
    this.nsfw = config.nsfw || false;

    /**
     * @property {CommandBaseCooldown} cooldown Cooldown configuration for the command
     */
    this.cooldown = config.cooldown || {
      type: 'member',
      usages: 1,
      duration: 2
    };

    /**
     * @property {string} category This command's category
     */
    this.category = config.category || undefined;

    /**
     * @property {Object} data Discord API Application Command Object {@link https://discord.com/developers/docs/interactions/application-commands#application-command-object}
     */
    this.data = config.data || {};

    /**
     * @property {string} filePath Path to file, only present if `this.setFilePathDetails` is invoked
     */
    this.filePath = config.filePath || undefined;

    // Overwriting the default callback function with the
    // user provided function
    this.run = config.run;

    // Validate our config now that it is overwritten
    this.validateConfig();
    // Transforming our perm level string into an integer
    this.setPermLevel();
  }

  /**
   * Transforms the required permLevel string into an integer
   * @method
   * @returns {void}
   */
  setPermLevel = () => {
    this.permLevel = Number(
      Object.entries(permLevelMap)
        .find(([lvl, name]) => name === this.permLevel)[0]
    );
  };

  /**
   * Validate our command config and API data
   * @method
   * @throws {Error} If an issue is encountered while validating the configuration
   * @returns {void} Nothing, if an Error isn't encountered, the command configuration is considered valid
   */
  // eslint-disable-next-line sonarjs/cognitive-complexity
  validateConfig = () => {
    // Destructure
    const { data, run } = this;

    // Check if valid permission level is supplied
    if (!permConfig.find((e) => e.name === this.permLevel)) {
      throw new Error(`The permission level "${this.permLevel}" is not currently configured.\nCommand: ${data.name}`);
    }

    // Check that optional client permissions are valid
    if (
      this.clientPerms
      &amp;&amp; !Array.isArray(this.clientPerms)
    ) throw new Error (`Invalid permissions provided in ${data.name} command client permissions\nCommand: ${data.name}`);

    // Check that optional user permissions are valid
    if (
      this.userPerms
      &amp;&amp; !Array.isArray(this.userPerms)
    ) throw new Error (`Invalid permissions provided in ${data.name} command user permissions\nCommand: ${data.name}`);

    // Check boolean nsfw
    if (typeof this.nsfw !== 'boolean') throw new Error(`Expected nsfw property to be boolean\nCommand: ${data.name}`);

    // Check our run function
    if (typeof run !== 'function') {
      throw new Error(`Expected run to be a function, but received ${typeof run}\nCommand: ${data.name}`);
    }

    // Check optional required client permissions
    if (this.clientPerms.length >= 1) {
      const invalidPerms = getInvalidPerms(this.clientPerms).map(e => chalk.red(e));
      if (invalidPerms.length >= 1) {
        throw new Error(`Invalid permissions provided in clientPerms: ${invalidPerms.join(', ')}\nCommand: ${data.name}`);
      }
    }

    // Check optional required user permissions
    if (this.userPerms.length >= 1) {
      const invalidPerms = getInvalidPerms(this.userPerms).map(e => chalk.red(e));
      if (invalidPerms.length >= 1) {
        throw new Error(`Invalid permissions provided in userPerms: ${invalidPerms.join(', ')}\nCommand: ${data.name}`);
      }
    }
  };

  /**
   * The callback executed when the command is ran
   * @member {CommandCallback}
   */
  run = () => {};

  /**
   * Grabs data from the origin file path to set `data.name` and `category` fallbacks
   * @method
   * @returns {void} Nothing
   */
  setFilePathDetails = () => {
    const origin = this.filePath;
    // Check if the data name has been set
    // Set filename without extension as fallback
    if (!this.data.name) {
      const fileNameWithoutExtension = origin.slice(
        origin.lastIndexOf(path.sep) + 1,
        origin.lastIndexOf('.')
      );
      this.data.name = fileNameWithoutExtension;
    }
    // Check if the category has been set
    // Set parent folder name as fallback
    if (!this.category) {
      const parentFolder = origin.slice(
        origin.lastIndexOf(path.sep, origin.lastIndexOf(path.sep) - 1) + 1,
        origin.lastIndexOf(path.sep) || undefined
      );
      this.category = parentFolder;
    }
  };

  /**
   * Loads the command, setting the filepath, printing to console, and adding to a {@link module:Client~ClientContainer} collection
   * @method
   * @param {string} origin The absolute file path to exported module/config,
   * can be used this way as we export each Command within it's own, dedicated file
   * @param {external:DiscordCollection} collection The collection this command should be set to
   * @returns {void} Nothing
   *
   * @example
   * for (const filePath of getFiles('src/commands')) {
   *  const command = require(filePath);
   *  command.load(filePath, client.container.commands);
   * }
   */
  load = (filePath, collection) => {
    this.filePath = filePath;
    this.setFilePathDetails();

    // Debug Logging - After we set our file path defaults/fallbacks
    if (DEBUG_ENABLED === 'true') {
      logger.debug(`Loading &lt;${chalk.cyanBright(this.data.name)}>`);
    }

    // Set the command in our command collection
    collection.set(this.data.name, this);
  };

  /**
   * Unloads the command, removing it from out  {@link module:Client~ClientContainer} collection and removing it from our module cache
   * @method
   * @param {external:DiscordCollection} collection The collection this command should be removed from
   * @returns {void} Nothing
   *
   * @example
   * const commands = client.container.commands;
   * const command = commands.get('eval');
   * command.unload(commands)
   */
  unload = (collection) => {
    // Getting and deleting our current cmd module cache
    collection.delete(this.data.name);
    const filePath = this.filePath;
    const module = require.cache[require.resolve(filePath)];
    delete require.cache[require.resolve(filePath)];
    for (let i = 0; i &lt; module.children.length; i++) {
      if (module.children[i] === module) {
        module.children.splice(i, 1);
        break;
      }
    }
  };

  /**
   * Reloads the command, shorthand for invoking `this.unload()` and `this.load()`
   * @method
   * @param {external:DiscordCollection} collection The collection this command should be removed from
   * @returns {void} Nothing
   */
  reload = (collection) => {
    this.unload(collection);
    // this.filePath is only present after the command has been loaded initially
    this.load(this.filePath, collection);
  };
}





/**
 * @extends {CommandBase}
 */
class ComponentCommand extends CommandBase {
}





/**
 * @typedef {BaseConfig} APICommandConfig
 * @property {boolean} [global=true] Is the command enabled globally or only in our test-server
 */

/**
 * Represents an API command, one of ChatInput (Slash), User Context Menu or Message Context Menu
 * @extends {CommandBase}
 * @example
 * const myApiCommand = new APICommand({
 *  global: false // Load as a server command instead of global
 * });
 */
class APICommand extends CommandBase {
  /**
   * @param {BaseConfig | APICommandConfig} config The full command configuration
   */
  constructor (config) {
    super(config);
    /**
     * @property {boolean} global Is the command enabled globally or only in our test-server
     */
    this.global = config.global || false;
  }
}





/**
 * @extends {APICommand}
 */
class MessageContextCommand extends APICommand {
  /**
   * @param {BaseConfig | APICommandConfig} config The full command configuration
   */
  constructor (cmd) {
    super(cmd);
    /**
     * @property {number} [data.type=3] The type of APICommand
     */
    this.data.type = 3; // MESSAGE Context Menu
  }
}





/**
 * @extends {APICommand}
 */
class UserContextCommand extends APICommand {
  /**
   * @param {BaseConfig | APICommandConfig} config The full command configuration
   */
  constructor (cmd) {
    super(cmd);
    /**
     * @property {number} [data.type=3] The type of APICommand
     */
    this.data.type = 2; // USER Context Menu
  }
}





/**
 * @extends {APICommand}
 * @example
 * const mySlashCommand = new ChatInputCommand({
 *  cooldown: {
 *   type: 'guild', // Use guild-type cooldown
 *   usages: 2, // Limit to 2 uses per guild
 *   duration: 60 // usages are tracked and active for 60 seconds
 *  }
 *  data: {
 *   description: 'A description is required for ChatInput commands on the Discord API'
 *  },
 *  // The commands callback function
 *  run: async (client, interaction) => {
 *   // Do something with the client and interaction
 *  }
 * });
 */
class ChatInputCommand extends APICommand {
  /**
   * @param {BaseConfig | APICommandConfig} config The full command configuration
   * @throws {Error} An Error if no `data.description` field is present, as this is required by Discord's API
   */
  constructor (config) {
    super(config);
    // Set API data defaults
    this.data.type = 1; // CHAT_INPUT

    // Check if a description is provided
    if (!this.data.description) {
      throw new Error(`An InteractionCommand description is required by Discord's API\nCommand: ${this.data.name}`);
    }
  }
}

module.exports = {
  CommandBase,
  APICommand,
  ChatInputCommand,
  ComponentCommand,
  MessageContextCommand,
  UserContextCommand
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Aug 22 2022 21:03:18 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
