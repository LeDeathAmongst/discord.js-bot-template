<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>handlers/commands.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Mirasaki/discord.js-bot-template" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Modules</h3><ul><li><a href="module-Client.html">Client</a></li><li><a href="module-Handler_Commands.html">Handler/Commands</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~checkCommandCanExecute">checkCommandCanExecute</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~clearApplicationCommandData">clearApplicationCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandInfoEmbed">generateCommandInfoEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~generateCommandOverviewEmbed">generateCommandOverviewEmbed</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandMap">getCommandMap</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getCommandSelectMenu">getCommandSelectMenu</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~getThrottleId">getThrottleId</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~hasAccessToComponentCommand">hasAccessToComponentCommand</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~isAppropriateCommandFilter">isAppropriateCommandFilter</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~logCommandApiData">logCommandApiData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~refreshSlashCommandData">refreshSlashCommandData</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerGlobalCommands">registerGlobalCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~registerTestServerCommands">registerTestServerCommands</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~sortCommandsByCategory">sortCommandsByCategory</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Commands.html#~throttleCommand">throttleCommand</a></li></ul></li><li><a href="module-Handler_Permissions.html">Handler/Permissions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getInvalidPerms">getInvalidPerms</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~getPermissionLevel">getPermissionLevel</a></li><li data-type='method' style='display: none;'><a href="module-Handler_Permissions.html#~hasChannelPerms">hasChannelPerms</a></li></ul></li><li><a href="module-Utils.html">Utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Utils.html#~capitalizeString">capitalizeString</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~colorResolver">colorResolver</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getBotInviteLink">getBotInviteLink</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getFiles">getFiles</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRelativeTime">getRelativeTime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~getRuntime">getRuntime</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~parseSnakeCaseArray">parseSnakeCaseArray</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~sleep">sleep</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~splitCamelCaseStr">splitCamelCaseStr</a></li><li data-type='method' style='display: none;'><a href="module-Utils.html#~titleCase">titleCase</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="APICommand.html">APICommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="APICommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="APICommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ChatInputCommand.html">ChatInputCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ChatInputCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="CommandBase.html">CommandBase</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CommandBase.html#load">load</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="CommandBase.html#validateConfig">validateConfig</a></li></ul></li><li><a href="ComponentCommand.html">ComponentCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ComponentCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="ComponentCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="MessageContextCommand.html">MessageContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="MessageContextCommand.html#validateConfig">validateConfig</a></li></ul></li><li><a href="UserContextCommand.html">UserContextCommand</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UserContextCommand.html#load">load</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#reload">reload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setFilePathDetails">setFilePathDetails</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#setPermLevel">setPermLevel</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#unload">unload</a></li><li data-type='method' style='display: none;'><a href="UserContextCommand.html#validateConfig">validateConfig</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-adding-commands.html">adding-commands</a></li><li><a href="tutorial-permissions.html">permissions</a></li></ul><h3>Externals</h3><ul><li><a href="external-DiscordActionRowBuilder.html">DiscordActionRowBuilder</a></li><li><a href="external-DiscordActivityOptions.html">DiscordActivityOptions</a></li><li><a href="external-DiscordAPIApplicationCommand.html">DiscordAPIApplicationCommand</a></li><li><a href="external-DiscordChatInputInteraction.html">DiscordChatInputInteraction</a></li><li><a href="external-DiscordClient.html">DiscordClient</a></li><li><a href="external-DiscordClientPresenceStatus.html">DiscordClientPresenceStatus</a></li><li><a href="external-DiscordCollection.html">DiscordCollection</a></li><li><a href="external-DiscordCommandInteraction.html">DiscordCommandInteraction</a></li><li><a href="external-DiscordEmbedBuilder.html">DiscordEmbedBuilder</a></li><li><a href="external-DiscordGatewayIntentBits.html">DiscordGatewayIntentBits</a></li><li><a href="external-DiscordGuildChannel.html">DiscordGuildChannel</a></li><li><a href="external-DiscordGuildMember.html">DiscordGuildMember</a></li><li><a href="external-DiscordPermissionResolvable.html">DiscordPermissionResolvable</a></li></ul><h3>Global</h3><ul><li><a href="global.html#APICommandConfig">APICommandConfig</a></li><li><a href="global.html#BaseConfig">BaseConfig</a></li><li><a href="global.html#CommandBaseCooldown">CommandBaseCooldown</a></li><li><a href="global.html#CommandCallback">CommandCallback</a></li><li><a href="global.html#CooldownTypes">CooldownTypes</a></li><li><a href="global.html#PermLevel">PermLevel</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">handlers/commands.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Our command handler, holds utility functions and everything to do with
 * handling commands in this template. Exported from `/src/handlers/commands.js`.
 * See {@tutorial adding-commands} for an overview.
 * @module Handler/Commands
 */

/**
 * Discord API command data
 * @external DiscordAPIApplicationCommand
 * @see {@link https://discord-api-types.dev/api/discord-api-types-v10/interface/APIApplicationCommand}
 */

/**
 * The command interaction received
 * @external DiscordCommandInteraction
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/CommandInteraction}
 */

/**
 * The `discord.js` ActionRowBuilder
 * @external DiscordActionRowBuilder
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/ActionRowBuilder}
 */

/**
 * The `discord.js` EmbedBuilder
 * @external DiscordEmbedBuilder
 * @see {@link https://discord.js.org/#/docs/discord.js/main/class/EmbedBuilder}
 */

// Require dependencies
const { REST } = require('@discordjs/rest');
const { Routes } = require('discord-api-types/v10');

// Local imports
const { titleCase, splitCamelCaseStr, colorResolver } = require('../util');
const emojis = require('../config/emojis.json');

// Packages
const logger = require('@mirasaki/logger');
const chalk = require('chalk');
const { hasChannelPerms } = require('./permissions');
const { commands, colors } = require('../client');
const {
  SELECT_MENU_MAX_OPTIONS,
  HELP_SELECT_MENU_SEE_MORE_OPTIONS,
  HELP_COMMAND_SELECT_MENU,
  MS_IN_ONE_SECOND
} = require('../constants');
const {
  ActionRowBuilder,
  SelectMenuBuilder,
  PermissionsBitField
} = require('discord.js');

// Destructure from process.env
const {
  DISCORD_BOT_TOKEN,
  CLIENT_ID,
  TEST_SERVER_GUILD_ID,
  REFRESH_SLASH_COMMAND_API_DATA,
  DEBUG_SLASH_COMMAND_API_DATA,
  DEBUG_COMMAND_THROTTLING
} = process.env;

// Initializing our REST client
const rest = new REST({ version: '10' })
  .setToken(DISCORD_BOT_TOKEN);

/**
 * Clears all InteractionCommand data from the Discord API, both global
 * and server-specific commands.
 * @throws {process.exit(1)} Shuts down the client/process after clearing API command data
 * @returns {void}
 */
const clearApplicationCommandData = () => {
  logger.info('Clearing ApplicationCommand API data');
  rest.put(Routes.applicationCommands(CLIENT_ID), { body: [] });
  rest.put(Routes.applicationGuildCommands(CLIENT_ID, TEST_SERVER_GUILD_ID), { body: [] })
    .catch((err) => {
      // Catching Missing Access error
      logger.syserr('Error encountered while trying to clear GuildCommands in the test server, this probably means your TEST_SERVER_GUILD_ID in the .env file is invalid or the client isn\'t currently in that server');
      logger.syserr(err);
    });
  logger.success(
    'Successfully reset all Slash Commands. It may take up to an hour for global changes to take effect.'
  );
  logger.syslog(chalk.redBright('Shutting down...'));
  process.exit(1);
};

/**
 * Sorts a collection of commands by command category
 * @param {Collection&lt;string, ChatInputCommand | UserContextCommand | MessageContextCommand>} commands The collections of commands to sort
 * @returns {Array&lt;Command>}
 */
const sortCommandsByCategory = (commands) => {
  let currentCategory = '';
  const sorted = [];
  commands.forEach(cmd => {
    const workingCategory = titleCase(cmd.category);
    if (currentCategory !== workingCategory) {
      sorted.push({
        category: workingCategory,
        commands: [cmd]
      });
      currentCategory = workingCategory;
    } else sorted.find(e => e.category === currentCategory).commands.unshift(cmd);
  });
  return sorted;
};

/**
 * Refreshes InteractionCommand ({@link ChatInputCommand}, {@link UserContextCommand}, and {@link MessageContextCommand}) API Data
 * @param {Client} client Our extended discord.js client
 * @returns {void} Nothing
 */
const refreshSlashCommandData = (client) => {
  // Environmental skip
  if (REFRESH_SLASH_COMMAND_API_DATA !== 'true') {
    logger.syslog(`Skipping application ${chalk.white('(/)')} commands refresh.`);
    return;
  }

  try {
    logger.startLog(`Refreshing Application ${chalk.white('(/)')} Commands.`);

    // Handle our different cmd config setups
    registerGlobalCommands(client); // Global Slash Command
    registerTestServerCommands(client); // Test Server Commands

    logger.endLog(`Refreshing Application ${chalk.white('(/)')} Commands.`);
  } catch (error) {
    logger.syserr(`Error while refreshing application ${chalk.white('(/)')} commands`);
    console.error(error);
  }
};

/**
 * Enum for API Command types
 * @readonly
 * @enum {string}
 */
const apiCommandTypeList = {
  /** Slash Command */
  1: 'Slash Command',
  /** User Context Menu */
  2: 'User Context Menu',
  /** Message Context Menu */
  3: 'Message Context Menu'
};

/**
 * (debug) Logs the Discord API InteractionCommand data to the console using `console.table`
 * @param {external:DiscordAPIApplicationCommand} apiData The data returned from the
 * Discord api after making a command request
 * @returns {void} Nothing
 */
const logCommandApiData = (cmdData) => {
  // Filtering out stuff we don't need and formatting
  const cleanedObjArr = cmdData.map(
    (data) => ({
      name: data.name,
      description: data.description || 'n/a',
      options: data.options?.length || 0,
      type: apiCommandTypeList[data.type]
    })
  );
  console.table(cleanedObjArr);
};

/**
 * Concatenates all our API command data, and refreshes/registers global command data to the Discord API
 * @param {Client} client Our extended discord.js client
 * @returns {Promise&lt;Array&lt;external:DiscordAPIApplicationCommand>>} Discord API command data
 */
const registerGlobalCommands = async (client) => {
  // Logging
  logger.info('Registering Global Application Commands');

  // Defining our variables
  const { commands, contextMenus } = client.container;
  const combinedData = commands.concat(contextMenus);
  const globalCommandData = combinedData
    .filter((cmd) =>
      cmd.global === true
      &amp;&amp; cmd.enabled === true
    )
    .map((cmd) => cmd.data);

  // Extensive debug logging
  if (DEBUG_SLASH_COMMAND_API_DATA === 'true') {
    logger.startLog('Global Command Data');
    logCommandApiData(globalCommandData);
    logger.endLog('Global Command Data');
  }

  // Sending the global command data
  return await rest.put(
    Routes.applicationCommands(CLIENT_ID),
    { body: globalCommandData }
  ).catch((err) => {
    // Invalid Form Body error
    if (err.status === 400) {
      logger.syserr(`Error encountered while trying to register command API data: ${err.message}`);
      for (const [ index ] in err.rawError.errors) {
        // Logging the invalid data to the console
        console.log(err.requestBody.json[Number(index)]);
      }
    }

    else {
      // Unknown errors
      logger.syserr(err);
    }
  });
};

/**
 * Concatenates all our API command data, and refreshes/registers server command data to the Discord API
 * @param {Client} client Our extended discord.js client
 * @returns {Promise&lt;Array&lt;external:DiscordAPIApplicationCommand>>} Discord API command data
 */
const registerTestServerCommands = async (client) => {
  // Defining our variables
  const { commands, contextMenus } = client.container;
  const combinedData = commands.concat(contextMenus);
  const testServerCommandData = combinedData
    .filter((cmd) =>
      cmd.global === false // Filter out global commands
      &amp;&amp; cmd.enabled === true
    )
    .map((cmd) => cmd.data);

  // Return if there's no test command data
  if (testServerCommandData.length === 0) {
    return true;
  }

  // Logging
  logger.info('Registering Test Server Commands');

  // Extensive debug logging
  if (DEBUG_SLASH_COMMAND_API_DATA === 'true') {
    logger.startLog('Test Server Command Data | Only active on the server defined in your .env file');
    logCommandApiData(testServerCommandData);
    logger.endLog('Test Server Command Data');
  }

  // Sending the test server command data
  return await rest.put(
    Routes.applicationGuildCommands(
      CLIENT_ID,
      TEST_SERVER_GUILD_ID // Providing our test server id
    ),
    { body: testServerCommandData }
  ).catch((err) => {
    // Invalid TEST_SERVER_GUILD_ID
    if (err.status === 404) {
      logger.syserr('Error encountered while trying to register GuildCommands in the test server, this probably means your TEST_SERVER_GUILD_ID in the .env file is invalid or the client isn\'t currently in that server');
      logger.printErr(err.stack || err);
    }

    // Invalid Form Body error
    else if (err.status === 400) {
      logger.syserr(`Error encountered while trying to register GuildCommands in the test server: ${err.message}`);
      for (const [ index ] in err.rawError.errors) {
        // Logging the invalid data to the console
        console.log(err.requestBody.json[Number(index)]);
      }
    }

    else {
      // Catching Missing Access error
      logger.printErr(err);
    }
  });
};

/**
 * Assigns a unique id depending on cooldown type and data id's
 * @param {CommandBaseCooldown} cooldown The cooldown configuration
 * @param {external:DiscordAPIApplicationCommand} data The Discord API command data
 * @param {external:DiscordCommandInteraction} interaction The interaction received where this cooldown will apply to
 * @returns {string} The unique identifier for the cooldown that will be applied
 */
const getThrottleId = (cooldown, data, interaction) => {
  // Destructure from interaction
  const { member, channel, guild } = interaction;

  // Building our unique identifier string
  let identifierStr;
  switch (cooldown.type) {
    case 'member': identifierStr = `${member.id}${guild.id}`; break;
    case 'guild': identifierStr = guild.id; break;
    case 'channel': identifierStr = channel.id; break;
    case 'global': identifierStr = ''; break;

    // By default only use member.id
    case 'user':
    default: {
      identifierStr = member.id;
      break;
    }
  }

  // Append the command name to the identifier string
  identifierStr += `-${data.name}`;

  // return the uid
  return identifierStr;
};

// Handling command cooldown
const ThrottleMap = new Map();
/**
 * Throttles the invoked command/applies &amp; manages cooldown for the command
 * @param {Command} clientCmd The command to throttle
 * @param {external:DiscordCommandInteraction} interaction The received interaction
 * @returns {boolean} Indicates if the command is actively being throttled.
 * true: It went through and was executed, false: command is actively being throttled / command denied.
 */
// eslint-disable-next-line sonarjs/cognitive-complexity
const throttleCommand = (clientCmd, interaction) => {
  const { config, data } = clientCmd;
  const { cooldown } = config;
  const debugStr = chalk.red('[Cmd Throttle]');

  // Check if a cooldown is configured
  if (cooldown === false) {
    if (DEBUG_COMMAND_THROTTLING === 'true') {
      logger.debug(`${debugStr} - ${data.name} No cooldown configured.`);
    }
    return false;
  }

  // Check if cooldown is valid
  const cooldownInMS = parseInt(cooldown.duration * MS_IN_ONE_SECOND);
  if (!cooldownInMS || cooldownInMS &lt; 0) {
    if (DEBUG_COMMAND_THROTTLING === 'true') {
      logger.debug(`${debugStr} - ${data.name} No cooldown configured.`);
    }
    return false;
  }

  // Get our command throttle id
  const identifierStr = getThrottleId(cooldown, data, interaction);

  // Debug logging
  if (DEBUG_COMMAND_THROTTLING === 'true') {
    logger.debug(`${debugStr} - ${chalk.green(identifierStr)} UID Applied to ${chalk.blue(data.name)} with cooldown type ${chalk.red(cooldown.type)}`);
  }

  // No data
  if (!ThrottleMap.has(identifierStr)) {
    // Additional debug logging
    if (DEBUG_COMMAND_THROTTLING === 'true') {
      logger.debug(`${debugStr} - ${chalk.green(identifierStr)} ThrottleMap data created, pushed this usage. Cooldown expires in ${cooldown.duration} seconds`);
    }
    ThrottleMap.set(identifierStr, [Date.now()]);
    setTimeout(() => {
      if (DEBUG_COMMAND_THROTTLING === 'true') {
        logger.debug(`${debugStr} - ${chalk.green(identifierStr)} ThrottleMap data expired, removed this usage.`);
      }
      ThrottleMap.delete(identifierStr);
    }, cooldownInMS);
    return false;
  }

  // Data was found
  else {
    const throttleData = ThrottleMap.get(identifierStr);
    const nonExpired = throttleData.filter((timestamp) => Date.now() &lt; (timestamp + cooldownInMS));

    // Return - Currently on cooldown
    if (nonExpired.length >= cooldown.usages) {
      if (DEBUG_COMMAND_THROTTLING === 'true') {
        logger.debug(`${debugStr} - ${chalk.green(identifierStr)} Command is actively being throttled, returning.`);
      }
      return `${emojis.error} {{user}}, you can use **\`/${data.name}\`** again in ${
        Number.parseFloat(((nonExpired[0] + cooldownInMS) - Date.now()) / MS_IN_ONE_SECOND).toFixed(2)
      } seconds`;
    }

    // Not on max-usages yet, increment usages
    else {
      if (DEBUG_COMMAND_THROTTLING === 'true') {
        logger.debug(`${debugStr} - ${chalk.green(identifierStr)} Incremented usage`);
      }
      throttleData.push(Date.now());
      return false;
    }
  }
};

/**
 * Checks if the command can execute in it's current state.
 * Checks internal permission level required, additional required Discord permissions,
 * if the command is currently enabled and if the command is NSFW and in a NSFW channel.
 * @param {Client} client Our extended discord.js client
 * @param {external:DiscordCommandInteraction} interaction The received interaction
 * @param {Command} clientCmd The command to check if it can execute
 * @returns {boolean} Indicates if the command can be executed or not.
 */
const checkCommandCanExecute = (client, interaction, clientCmd) => {
  // Required destructuring
  const { member, channel } = interaction;
  const { emojis } = client.container;
  const { data, permLevel, enabled, clientPerms, userPerms, nsfw } = clientCmd;

  // Get permission levels
  const commandPermLvl = permLevel;

  // Check if the command is currently disabled
  // Needed 'cuz it takes a while for CommandInteractions to sync across server
  if (enabled === false) {
    interaction.reply({
      content: `${emojis} ${member}, this command is currently disabled. Please try again later.`
    });
    return false;
  }

  // Fallback for unexpected results
  if (isNaN(commandPermLvl)) {
    interaction.reply({
      content: `${emojis.error} ${member}, something went wrong while using this command.\n${emojis.info} This issue has been logged to the developer.\n${emojis.wait} Please try again later`,
      ephemeral: true
    });
    logger.syserr(`Interaction returned: Calculated permission level for command ${data.name} is NaN.`);
    return false;
  }

  // Check if they have the required permission level
  if (member.permLevel &lt; commandPermLvl) {
    interaction.reply({
      content: `${emojis.error} ${member}, you do not have the required permission level to use this command.`
    });
    return false;
  }

  // Check for missing client Discord App permissions
  if (clientPerms.length !== 0) {
    const missingPerms = hasChannelPerms(client.user.id, channel, clientPerms);
    if (missingPerms !== true) {
      interaction.reply({
        content: `${emojis.error} ${member}, this command can't be executed because I lack the following permissions in ${channel}\n${emojis.separator} ${missingPerms.join(', ')}`
      });
      return false;
    }
  }

  // Check for missing user Discord App permissions
  if (userPerms.length !== 0) {
    const missingPerms = hasChannelPerms(member.user.id, channel, userPerms);
    if (missingPerms !== true) {
      interaction.reply({
        content: `${emojis.error} ${member}, this command can't be executed because you lack the following permissions in ${channel}:\n${emojis.separator} ${missingPerms.join(', ')}`
      });
      return false;
    }
  }

  // Check for NSFW commands and channels
  if (nsfw === true &amp;&amp; channel.nsfw !== true) {
    interaction.reply({
      content: `${emojis.error} ${member}, that command is marked as **NSFW**, you can't use it in a **SFW** channel!`,
      ephemeral: true
    });
    return false;
  }

  // All checks have passed
  return true;
};

/**
 * Checks if the member has access to the component command
 * @param {external:DiscordCommandInteraction} interaction The received interaction
 * @returns {boolean} Indicates if the component command is meant for the user that invoked it
 */
const hasAccessToComponentCommand = (interaction) => {
  const { member, message } = interaction;
  const originInteractionUserId = message.interaction.user?.id;
  return member.id === originInteractionUserId;
};

/**
 * Represents a filter that filters out commands that aren't appropriate for the invoker,
 * checks permission level, server-specific commands, and if the command is enabled
 * @param {external:DiscordGuildMember} member The Discord API member object, extended by discord.js
 * @param {commandBaseConfig} cmdConfig Our client-side command configuration
 * @returns {boolean} Indicates whether or not this command is appropriate for the command invoker
 */
const isAppropriateCommandFilter = (member, cmdConfig) =>
  // Check permission level
  member.permLevel >= cmdConfig.permLevel
  // Filtering out disabled commands
  &amp;&amp; cmdConfig.enabled === true
  // Filtering out test commands
  &amp;&amp; (
    cmdConfig.global === true
      ? true
      : member.guild.id === TEST_SERVER_GUILD_ID
  );

// Defining our empty command map
const commandMap = [];

/**
 * Represents an object with minimal {@link Command} data
 * @typedef CommandMapDataObj
 * @property {string} name The name of the command
 * @property {number} permLevel A number representing the required permission level
 * @property {string} category The category this command belongs too
 * @property {boolean} global Indicates if the command is enabled globally
 */

/**
 * Returns an array with minimal command data
 * @returns {Array&lt;module:Handler/Commands~CommandMapDataObj>}
 */
const getCommandMap = () => {
  // Defining our function to populate our commandMap
  // We cant use "commands.map()" because this is located
  // in our top level scope - so it would retrieve the empty collection
  if (commandMap.length === 0) {
    for (const cmd of commands) {
      const { data, enabled, permLevel, global, category } = cmd[1];
      // Checking for command availability
      if (!enabled) continue;

      // Pushing the entry to our map if it's available
      commandMap.push({
        name: data.name,
        permLevel,
        description: data.description,
        category,
        global
      });
    }
  }

  // Return the result
  return commandMap;
};

/**
 * Generates a Select Menu data object using command data
 * @param {external:DiscordGuildMember} member The Discord API member
 * @returns {external:DiscordActionRowBuilder} The final select menu data object
 */
const getCommandSelectMenu = (member) => {
  // Filtering out unusable commands
  const commandMap = getCommandMap();
  const workingCmdMap = commandMap.filter((cmd) => isAppropriateCommandFilter(member, cmd));

  // Getting our structured array of objects
  let cmdOutput = workingCmdMap.map((cmd) => ({
    label: cmd.name,
    description: cmd.description,
    value: cmd.name
  }));

  // If too long, slice chunk out and notify member
  if (cmdOutput.length > SELECT_MENU_MAX_OPTIONS) {
    const remainder = cmdOutput.length - (SELECT_MENU_MAX_OPTIONS - 1);
    cmdOutput = cmdOutput.slice(0, (SELECT_MENU_MAX_OPTIONS - 1));
    cmdOutput.push({
      label: `And ${remainder} more...`,
      description: 'Use the built-in auto complete functionality when typing the command',
      value: HELP_SELECT_MENU_SEE_MORE_OPTIONS
    });
  }

  // Building our row
  return new ActionRowBuilder()
    .addComponents(
      new SelectMenuBuilder()
        .setCustomId(HELP_COMMAND_SELECT_MENU)
        .setPlaceholder('Select a command')
        .addOptions(cmdOutput)
        .setMinValues(1)
        .setMaxValues(1)
    );
};

/**
 * Generates an embed displaying command information
 * @param {Command} clientCmd The command object to build the embed from
 * @param {external:DiscordCommandInteraction} interaction The received interaction
 * @returns {external:DiscordEmbedBuilder} The final embed with the command information
 */
const generateCommandInfoEmbed = (clientCmd, interaction) => {
  // Destructure from our clientCmd object
  const { data, cooldown, clientPerms, userPerms, category } = clientCmd;
  const { channel, member } = interaction;

  // Utility function for displaying our permission requirements
  const getPermOutput = (permArr) => {
    return permArr.length >= 1
      ? permArr
        .map((perm) => `${
          channel.permissionsFor(member.user.id).has(PermissionsBitField.Flags[perm])
            ? emojis.success
            : emojis.error
        } ${splitCamelCaseStr(perm, ' ')}
        `)
        .join('\n')
      : `${emojis.success} None required`;
  };

  return {
    color: colorResolver(colors.main),
    title: titleCase(data.name),
    description: `${data.description}`,
    fields: [
      {
        name: 'Category',
        value: titleCase(category),
        inline:  true
      },
      {
        name: `${emojis.wait} Cooldown`,
        value: `You can use this command **${
          cooldown.usages === 1 ? 'once' :
            cooldown.usages === 2 ? 'twice' : `${cooldown.usages} times`
        }** every **${cooldown.duration}** second${cooldown.duration === 1 ? '' : 's'}`,
        inline: false
      },
      {
        name: 'Client Permissions',
        value: getPermOutput(clientPerms),
        inline: true
      },
      {
        name: 'User Permissions',
        value: getPermOutput(userPerms),
        inline: true
      },
      {
        name: 'SFW',
        value: data.NSFW === true ? `${emojis.error} This command is **not** SFW` : `${emojis.success} This command **is** SFW`,
        inline: false
      }
    ]
  };
};

/**
 * Generates an embed displaying all available commands
 * @param {external:DiscordCollection&lt;string, ChatInputCommand>} commands The commands to generate the embed from
 * @param {external:DiscordCommandInteraction} interaction The received interaction to read data from
 * @returns {external:DiscordEmbedBuilder} The final embed data object
 */
const generateCommandOverviewEmbed = (commands, interaction) => {
  const { member, guild } = interaction;

  // Generate our embed field data
  const fields = [
    ...sortCommandsByCategory(
      // Filtering out command the user doesn't have access to
      commands.filter((cmd) => cmd.permLevel &lt;= member.permLevel)
    )
      .map((entry) => {
        return {
          name: `${entry.category}`,
          value: `**\`${
            entry.commands
              .map((cmd) => cmd.data.name)
              .join('`** - **`')
          }\`**`,
          inline: false
        };
      })
  ];

  return {
    title: `Command help for ${guild.name}`,
    color: colorResolver(colors.main),
    fields,
    footer: {
      text: `Requested by ${member.user.tag}`
    }
  };
};

module.exports = {
  apiCommandTypeList,
  clearApplicationCommandData,
  refreshSlashCommandData,
  sortCommandsByCategory,
  throttleCommand,
  checkCommandCanExecute,
  hasAccessToComponentCommand,
  isAppropriateCommandFilter,
  getCommandMap,
  getCommandSelectMenu,
  generateCommandInfoEmbed,
  generateCommandOverviewEmbed
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Aug 22 2022 21:03:18 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
